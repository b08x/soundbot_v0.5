# Jumpbox ansible roles

## Overview

This set of playbooks will turn a general Ubuntu LTS (14.04) or Centos 7 (and possibly RHEL 7) host into a jump box. This is a box that acts as an SSH gateway for users to your network, and also provides an OpenVPN server (with CA) to allow non-SSH access. 

As a general rule, you should *not* run any other unneeded services on a host like this, and you should use something more secure than passwords for authentication.

The approach implemented here requires that users have SSH keys present on the server, and OpenVPN authentication is done using keys generated by the easy-rsa CA solution.

---

## Requirements
The Ansible controller should be running the latest version from https://github.com/ansible/ansible and the target must be an Ubuntu 14.04 LTS or Centos 7 host. RedHat Enterprise Linux 7 will be tested in the coming weeks.

You should also have one existing user who is able to ssh to the host using a key to authenticate, and be able to sudo to root. This role will disable login for root over SSH and also disable password logins unless you make some changes.

---

## Basic Usage
This assumes that all variables and templates are already exactly as you would like them. **This is not likely to be true!** For more information about customization and options available, *please* read the rest of ths README. 

#### Deployment
Add role to server

#### Generating individual client ovpn config files
To generate an ovpn config for a client, you'll use the `create_vpn_key.yml` playbook. You need to supply the name of the VPN host that you want to use and also the name of the client to create on the commandline:

```ansible-playbook --extra-vars '{"vpnhost": "<yourvpnhost>", "client": "<clienttocreate>"}' create_vpn_key.yml```

For example, if I wanted to create an ovpn config with on a host named jumpbox for my ipad, I might use 

```ansible-playbook --extra-vars '{"vpnhost": "jumpbox", "client": "anonymouslemming-ipad"}' create_vpn_key.yml```

Once you've run this, you'll find the device key, certificate, csr and ovpn config under `/etc/openvpn/easy-rsa/keys` prefixed with the client value you set above. In my example, I would have 
   * anonymouslemming-ipad.crt
   * anonymouslemming-ipad.csr
   * anonymouslemming-ipad.key
   * anonymouslemming-ipad.ovpn

You can then provide whichever of these files is needed for your OpenVPN client application to your users.

##### Client entry for iOS vs Tunnelblick
In a generated .ovpn file, you'll note that the first line is `tls-client`. This works out of the box for iOS clients, but does not work with [Tunnelblick](https://tunnelblick.net/).

If you want to use a .ovpn file with Tunnelblick, please change `tls-client` to `client` before adding the VPN connection.


---

## Variable files and templates 
### openvpn_with_ca
#### variables - roles/openvpn_with_ca/vars/main.yml
Here, you'll define your VPN network (not your private network - the network range to be used by OpenVPN) and your key details that will be used for both the OpenVPN server and also individual device or user vpn keys. 

#### variables - roles/openvpn_with_ca/vars/default.yml , Debian.yml and RedHat.yml
Package and service names may differ between Ubuntu and RedHat. The default.yml should work for Ubuntu, but RedHat.yml is used for Centos and RedHat systems. The key differences here are
    * OpenVPN service name is openvpn@server.service instead of just openvpn
	* Group to run as is nobody instead of nogroup on Ubuntu

#### templates - roles/openvpn_with_ca/templates
##### etc_openvpn_server.conf.j2
This is the OpenVPN server config and will be deployed to /etc/openvpn/server.conf. Sensible defailts have been used and you shouldn't need to edit this for basic usage. 

Ansible will use some information from your host when populating this template, specifically the nameservers and search entries from the ansible_dns section. If you're having problem with DNS lookups after deploying this, check that these are populated by running `ansible -m setup <yourvpnhost>` and look for the ansible_dns section.
	
##### etc_openvpn_easy-rsa_vars.j2
Deployed to /etc/openvpn/easy-rsa/vars and used by all Easy RSA scripts. The variables from roles/openvpn_with_ca/vars/main.yml are used here.

##### etc_openvpn_sample.ovpn.j2
Last, but not least, we have the template used to create ovpn files once the vpn is deployed. This will not be copied to the server, but instead used each time you use the `create_vpn_key.yml` playbook. 

There is one change that is likely to be needed here, and that's the `remote` line. This should be changed to something that clients can reach from outside your network. 
